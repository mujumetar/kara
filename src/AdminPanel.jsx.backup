import { useEffect, useState } from "react";
import axios from "axios";
import API from "./api";
const HF_TOKEN = "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"; // Replace with your Hugging Face API token
export default function AdminPanel() {
  const [active, setActive] = useState("dashboard");
  const [loading, setLoading] = useState(false);
  const [products, setProducts] = useState([]);
  const [orders, setOrders] = useState([]);
  const [users, setUsers] = useState([]);
  const [slides, setSlides] = useState([]);
  const [categories, setCategories] = useState([]);
  const [stats, setStats] = useState({});
  const [search, setSearch] = useState({ users: '', orders: '', products: '' });
  const allowed = ["Pending", "Processing", "Confirmed", "Shipped", "Delivered"];
  const [form, setForm] = useState({
    title: "",
    price: "",
    category: "",
    subcategory: "",
    description: "",
    stock: "",
    images: []
  });
  const ORDER_FLOW = [
    "Pending",
    "Processing",
    "Confirmed",
    "Shipped",
    "Delivered",
  ];
  const [slideForm, setSlideForm] = useState({ title: "", link: "", image: null });
  // For categories
  const [catForm, setCatForm] = useState({ name: "", subcategories: "" });
  const [editingCatId, setEditingCatId] = useState(null);
  // For product subcategory dropdown
  const [availableSubcategories, setAvailableSubcategories] = useState([]);
  const [editingProductId, setEditingProductId] = useState(null);
  const [editingSlideId, setEditingSlideId] = useState(null);
  const pageSize = 10;
  const [productPage, setProductPage] = useState(1);
  const [orderPage, setOrderPage] = useState(1);
  const [userPage, setUserPage] = useState(1);
  const [expandedOrder, setExpandedOrder] = useState(null);
  const [generatingDesc, setGeneratingDesc] = useState(false);
  useEffect(() => {
    fetchAll();
    fetchSlides();
    fetchStats();
  }, []);
  const fetchAll = async () => {
    setLoading(true);
    try {
      const [prodsRes, ordsRes, usrsRes, catsRes] = await Promise.all([
        API.get(`/api/products?search=${search.products}`),
        API.get(`/api/admin/orders?search=${search.orders}`),
        API.get(`/api/admin/users?search=${search.users}`),
        API.get("/api/categories")
      ]);
      setProducts(prodsRes.data);
      setOrders(ordsRes.data);
      setUsers(usrsRes.data);
      setCategories(catsRes.data);
    } catch (error) {
      console.error("Error fetching data:", error);
    }
    setLoading(false);
  };
  const fetchSlides = async () => {
    try {
      setSlides((await API.get("/api/slider")).data);
    } catch (error) {
      console.error("Error fetching slides:", error);
    }
  };
  const fetchStats = async () => {
    try {
      const res = await API.get("/api/admin/stats");
      setStats(res.data);
    } catch (error) {
      console.error("Error fetching stats:", error);
    }
  };
  const addProduct = async () => {
    try {
      const fd = new FormData();
      fd.append("title", form.title);
      fd.append("price", form.price);
      fd.append("category", form.category);
      fd.append("subcategory", form.subcategory || "");
      fd.append("description", form.description || "");
      fd.append("stock", form.stock);
      if (form.images && form.images.length > 0) {
        form.images.forEach((image) => fd.append("images", image));
      }
      if (editingProductId) {
        await API.put(`/api/products/${editingProductId}`, fd);
        setEditingProductId(null);
      } else {
        await API.post("/api/products", fd);
      }
      setForm({
        title: "",
        price: "",
        category: "",
        subcategory: "",
        description: "",
        stock: "",
        images: []
      });
      setAvailableSubcategories([]);
      fetchAll();
    } catch (error) {
      console.error("Error adding product:", error);
    }
  };
  const generateDescription = async () => {
    if (!form.title) return alert("Product title is required");
    if (!form.images.length && !editingProductId) return alert("At least one image is required");
    setGeneratingDesc(true);
    try {
      let image;
      if (form.images.length > 0) {
        image = form.images[0];
      } else if (editingProductId) {
        const product = products.find(p => p._id === editingProductId);
        if (product?.images?.[0]) {
          const res = await fetch(product.images[0]);
          image = await res.blob();
        } else {
          return alert("No image available for generation");
        }
      }
      // Get caption from image
      const formData = new FormData();
      formData.append('file', image, 'image.jpg');
      const captionRes = await axios.post(
        'https://router.huggingface.co/models/Salesforce/blip-image-captioning-base',
        formData,
        {
          headers: {
            'Authorization': `Bearer ${HF_TOKEN}`,
            'Content-Type': 'multipart/form-data'
          }
        }
      );
      const caption = captionRes.data[0].generated_text;
      // Generate description from title and caption
      const input = `Generate a detailed product description for "${form.title}": ${caption}`;
      const descRes = await axios.post(
        '/hf/models/distilgpt2',
        { inputs: input },
        {
          headers: {
            'Authorization': `Bearer ${HF_TOKEN}`
          }
        }
      );
      const description = descRes.data[0].generated_text.trim();
      setForm({ ...form, description });
    } catch (error) {
      console.error("Error generating description:", error);
      alert("Failed to generate description. Please try again.");
    } finally {
      setGeneratingDesc(false);
    }
  };
  const deleteProduct = async (id) => {
    if (!confirm("Are you sure you want to delete this product?")) return;
    await API.delete(`/api/products/${id}`);
    fetchAll();
  };
  const editProduct = (p) => {
    setEditingProductId(p._id);
    setForm({
      title: p.title,
      price: p.price,
      category: p.category,
      subcategory: p.subcategory,
      description: p.description,
      stock: p.stock,
      images: []
    });
    handleCategoryChange({ target: { value: p.category } });
  };
  const addSlide = async () => {
    const fd = new FormData();
    Object.keys(slideForm).forEach((k) => slideForm[k] && fd.append(k, slideForm[k]));
    if (editingSlideId) {
      await API.put(`/api/slider/${editingSlideId}`, fd);
      setEditingSlideId(null);
      setSlideForm({ title: "", link: "", image: null });
    } else {
      await API.post("/api/slider", fd);
      setSlideForm({ title: "", link: "", image: null });
    }
    fetchSlides();
  };
  const deleteSlide = async (id) => {
    if (!confirm("Are you sure you want to delete this slide?")) return;
    await API.delete(`/api/slider/${id}`);
    fetchSlides();
  };
  const editSlide = (s) => {
    setEditingSlideId(s._id);
    setSlideForm({ title: s.title, link: s.link, image: null });
  };
  const addOrUpdateCategory = async () => {
    const subcats = catForm.subcategories
      .split(",")
      .map((s) => s.trim())
      .filter(Boolean);
    const data = { name: catForm.name, subcategories: subcats };
    try {
      if (editingCatId) {
        await API.put(`/api/categories/${editingCatId}`, data);
        setEditingCatId(null);
      } else {
        await API.post("/api/categories", data);
      }
      setCatForm({ name: "", subcategories: "" });
      fetchAll();
    } catch (error) {
      console.error("Error saving category:", error);
    }
  };
  const deleteCategory = async (id) => {
    if (!confirm("Are you sure you want to delete this category?")) return;
    try {
      await API.delete(`/api/categories/${id}`);
      fetchAll();
    } catch (error) {
      console.error("Error deleting category:", error);
    }
  };
  const editCategory = (cat) => {
    setEditingCatId(cat._id);
    setCatForm({
      name: cat.name,
      subcategories: cat.subcategories.join(", ")
    });
  };
  const handleCategoryChange = async (e) => {
    const val = e.target.value;
    setForm({ ...form, category: val, subcategory: "" });
    setAvailableSubcategories([]);
    if (val) {
      try {
        const res = await API.get(`/api/categories/${val}/subcategories`);
        setAvailableSubcategories(res.data);
      } catch (error) {
        console.error("Error fetching subcategories:", error);
      }
    }
  };
  const handleSearchChange = (type, value) => {
    setSearch({ ...search, [type]: value });
    // Debounce fetch if needed, but for simplicity refetch on change
    setTimeout(() => fetchAll(), 500);
  };
  const paginatedProducts = products.slice(
    (productPage - 1) * pageSize,
    productPage * pageSize
  );
  const paginatedOrders = orders.slice(
    (orderPage - 1) * pageSize,
    orderPage * pageSize
  );
  const paginatedUsers = users.slice(
    (userPage - 1) * pageSize,
    userPage * pageSize
  );
  // Function to get user details for an order
  const getUserDetails = (order) => {
    const user = order?.userId;

    return {
      name: user?.name || "N/A",
      email: user?.email || "N/A",
      phone: order?.address?.phone || "N/A",
    };
  };

  // console.log(user)
  const nextPage = (current, setter, total) => {
    if (current * pageSize < total) setter(current + 1);
  };
  const prevPage = (current, setter) => {
    if (current > 1) setter(current - 1);
  };
  return (
    <div style={styles.layout}>
      {/* SIDEBAR */}
      <aside style={styles.sidebar}>
        <h2 style={styles.logo}>Admin Panel</h2>
        {["dashboard", "products", "orders", "users", "categories", "slider"].map((s) => (
          <button
            key={s}
            onClick={() => setActive(s)}
            style={{
              ...styles.menuBtn,
              background: active === s ? "#2563eb" : "transparent",
            }}
          >
            {s.toUpperCase()}
          </button>
        ))}
      </aside>
      {/* MAIN */}
      <main style={styles.main}>
        <header style={styles.header}>
          <h2>{active.toUpperCase()}</h2>
          <button
            style={styles.logoutBtn}
            onClick={() => {
              localStorage.clear();
              location.reload();
            }}
          >
            Logout
          </button>
        </header>
        {loading && <div style={styles.loading}>Loading...</div>}
        {/* DASHBOARD */}
        {active === "dashboard" && (
          <section>
            <h3>Dashboard Stats</h3>
            <div style={styles.statsGrid}>
              <div style={styles.statCard}>
                <h4>Total Users</h4>
                <p style={styles.statValue}>{stats.totalUsers || 0}</p>
              </div>
              <div style={styles.statCard}>
                <h4>Total Orders</h4>
                <p style={styles.statValue}>{stats.totalOrders || 0}</p>
              </div>
              <div style={styles.statCard}>
                <h4>Total Revenue</h4>
                <p style={styles.statValue}>₹{stats.totalRevenue || 0}</p>
              </div>
              <div style={styles.statCard}>
                <h4>Pending Orders</h4>
                <p style={styles.statValue}>{stats.pendingOrders || 0}</p>
              </div>
            </div>
          </section>
        )}
        {/* PRODUCTS */}
        {active === "products" && (
          <section>
            <div style={styles.searchRow}>
              <input
                style={styles.searchInput}
                placeholder="Search products..."
                value={search.products}
                onChange={(e) => handleSearchChange('products', e.target.value)}
              />
            </div>
            <h3>{editingProductId ? "Edit Product" : "Add Product"}</h3>
            <div style={styles.formGrid}>
              <input
                style={styles.input}
                placeholder="Title"
                value={form.title}
                onChange={(e) => setForm({ ...form, title: e.target.value })}
              />
              <input
                style={styles.input}
                placeholder="Price"
                value={form.price}
                onChange={(e) => setForm({ ...form, price: e.target.value })}
              />
              <input
                style={styles.input}
                placeholder="Description"
                value={form.description}
                onChange={(e) => setForm({ ...form, description: e.target.value })}
              />
              <button
                style={{ ...styles.primaryBtn, gridColumn: 'span 2' }}
                onClick={generateDescription}
                disabled={generatingDesc}
              >
                {generatingDesc ? "Generating..." : "Generate Description with AI"}
              </button>
              <input
                style={styles.input}
                placeholder="Stock"
                value={form.stock}
                onChange={(e) => setForm({ ...form, stock: e.target.value })}
              />
              <select
                style={styles.input}
                value={form.category}
                onChange={handleCategoryChange}
              >
                <option value="">Select Category</option>
                {categories.map((c) => (
                  <option key={c._id} value={c.name}>
                    {c.name}
                  </option>
                ))}
              </select>
              <select
                style={styles.input}
                value={form.subcategory}
                onChange={(e) => setForm({ ...form, subcategory: e.target.value })}
                disabled={!form.category}
              >
                <option value="">Select Subcategory</option>
                {availableSubcategories.map((s) => (
                  <option key={s} value={s}>
                    {s}
                  </option>
                ))}
              </select>
              <input
                style={styles.fileInput}
                type="file"
                multiple
                onChange={(e) =>
                  setForm({ ...form, images: Array.from(e.target.files) })
                }
              />
            </div>
            <button style={styles.primaryBtn} onClick={addProduct}>
              {editingProductId ? "Update Product" : "Add Product"}
            </button>
            {editingProductId && (
              <button
                style={{ ...styles.primaryBtn, background: "#6b7280", marginLeft: 10 }}
                onClick={() => {
                  setEditingProductId(null);
                  setForm({ title: "", price: "", category: "", subcategory: "", description: "", stock: "", images: [] });
                }}
              >
                Cancel
              </button>
            )}
            <h3>Products</h3>
            <table style={styles.table}>
              <thead>
                <tr>
                  <th>Image</th>
                  <th>Title</th>
                  <th>Category/Subcategory</th>
                  <th>Price</th>
                  <th>Stock</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {paginatedProducts.map((p) => (
                  <tr key={p._id}>
                    <td><img src={p.images?.[0]} width="40" alt="Product" /></td>
                    <td>{p.title}</td>
                    <td>{p.category} / {p.subcategory}</td>
                    <td>₹{p.price}</td>
                    <td>{p.stock}</td>
                    <td>
                      <button style={styles.editBtn} onClick={() => editProduct(p)}>Edit</button>
                      <button style={styles.deleteBtn} onClick={() => deleteProduct(p._id)}>Delete</button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
            <div style={styles.pagination}>
              <button onClick={() => prevPage(productPage, setProductPage)}>Prev</button>
              <span>Page {productPage}</span>
              <button onClick={() => nextPage(productPage, setProductPage, products.length)}>Next</button>
            </div>
          </section>
        )}
        {/* ORDERS */}
        {active === "orders" && (
          <section>
            <div style={styles.searchRow}>
              <input
                style={styles.searchInput}
                placeholder="Search orders by user ID..."
                value={search.orders}
                onChange={(e) => handleSearchChange('orders', e.target.value)}
              />
            </div>
            <table style={styles.table}>
              <thead>
                <tr>
                  <th>Order ID</th>
                  <th>User</th>
                  <th>Amount</th>
                  <th>Status</th>
                  <th>Created</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {paginatedOrders.map((o) => (
                  <tr key={o._id}>
                    <td>{o._id.slice(-6)}</td>
                    <td>{getUserDetails(o).name || o.userId}</td>
                    <td>₹{o.totalAmount}</td>
                    <td>
                      <span style={{ ...styles.statusBadge, color: styles.statusBadge[o.status.toLowerCase()]?.color }}>
                        {o.status}
                      </span>
                    </td>
                    <td>{new Date(o.createdAt).toLocaleDateString()}</td>
                    <td>
                      <select
                        value={o.status}
                        onChange={async (e) => {
                          await API.patch(`/api/admin/orders/${o._id}/status`, {
                            status: e.target.value,
                          });
                          fetchAll();
                        }}
                      >
                        {allowed.map(s => <option key={s} value={s}>{s}</option>)}
                      </select>
                      <button style={styles.viewBtn} onClick={() => setExpandedOrder(expandedOrder?._id === o._id ? null : o)}>
                        {expandedOrder === o._id ? 'Hide' : 'View'}
                      </button>
                      <button style={styles.deleteBtn} onClick={async () => {
                        if (confirm('Delete order?')) {
                          await API.delete(`/api/admin/orders/${o._id}`);
                          fetchAll();
                        }
                      }}>Delete</button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
            {expandedOrder && (
              <div style={styles.orderDetails}>
                <h4>Order Tracking</h4>
                <OrderTimeline
                  status={expandedOrder.status}
                  createdAt={expandedOrder.createdAt}
                  updatedAt={expandedOrder.updatedAt}
                />
                {/* <div style={styles.orderSection}>
      <h5>User Details</h5>
      {Object.entries(getUserDetails(expandedOrder.userId)).map(([k, v]) => (
        <p key={k}><b>{k}:</b> {v}</p>
      ))}
    </div> */}

                <div style={styles.orderSection}>
                  <h5>User Details</h5>
                  {(() => {
                    const user = getUserDetails(expandedOrder);
                    return (
                      <>
                        <p><b>Name:</b> {user.name}</p>
                        <p><b>Email:</b> {user.email}</p>
                        <p><b>Phone:</b> {user.phone}</p>
                      </>
                    );
                  })()}
                </div>

                {expandedOrder.address && (
                  <div style={styles.orderSection}>
                    <h5>Delivery Address</h5>
                    {Object.entries(expandedOrder.address).map(([k, v]) => (
                      <p key={k}><b>{k}:</b> {v}</p>
                    ))}
                  </div>
                )}
                <div style={styles.orderSection}>
                  <h5>Products</h5>
                  <table style={{ width: "100%" }}>
                    <thead>
                      <tr>
                        <th align="left">Product</th>
                        <th>Qty</th>
                        <th>Price</th>
                        <th>Total</th>
                      </tr>
                    </thead>
                    <tbody>
                      {expandedOrder.products.map((p, i) => (
                        <tr key={i}>
                          <td>{p.title}</td>
                          <td align="center">{p.quantity || 1}</td>
                          <td align="center">₹{p.price}</td>
                          <td align="center">
                            ₹{(p.quantity || 1) * p.price}
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
            )}
            <div style={styles.pagination}>
              <button onClick={() => prevPage(orderPage, setOrderPage)}>Prev</button>
              <span>Page {orderPage}</span>
              <button onClick={() => nextPage(orderPage, setOrderPage, orders.length)}>Next</button>
            </div>
          </section>
        )}
        {/* USERS */}
        {active === "users" && (
          <section>
            <div style={styles.searchRow}>
              <input
                style={styles.searchInput}
                placeholder="Search users by name or email..."
                value={search.users}
                onChange={(e) => handleSearchChange('users', e.target.value)}
              />
            </div>
            <table style={styles.table}>
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Phone</th>
                  <th>Supercoins</th>
                  <th>Status</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                {paginatedUsers.map((u) => (
                  <tr key={u._id}>
                    <td>{u.name}</td>
                    <td>{u.email}</td>
                    <td>{u.phone}</td>
                    <td>{u.supercoins}</td>
                    <td>
                      {u.isBanned ? (
                        <span style={styles.banned}>BANNED</span>
                      ) : (
                        <span style={styles.active}>ACTIVE</span>
                      )}
                    </td>
                    <td>
                      <button
                        style={{
                          ...styles.primaryBtn,
                          background: u.isBanned ? "#16a34a" : "#dc2626",
                        }}
                        onClick={async () => {
                          await API.patch(`/api/admin/users/${u._id}/ban`);
                          fetchAll();
                        }}
                      >
                        {u.isBanned ? "Unban" : "Ban"}
                      </button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
            <div style={styles.pagination}>
              <button onClick={() => prevPage(userPage, setUserPage)}>Prev</button>
              <span>Page {userPage}</span>
              <button onClick={() => nextPage(userPage, setUserPage, users.length)}>Next</button>
            </div>
          </section>
        )}
        {/* CATEGORIES */}
        {active === "categories" && (
          <section>
            <h3>{editingCatId ? "Update Category" : "Add Category"}</h3>
            <div style={styles.formGrid}>
              <input
                style={styles.input}
                placeholder="Category Name"
                value={catForm.name}
                onChange={(e) =>
                  setCatForm({ ...catForm, name: e.target.value })
                }
              />
              <textarea
                style={{ ...styles.input, height: "80px" }}
                placeholder="Subcategories (comma separated)"
                value={catForm.subcategories}
                onChange={(e) =>
                  setCatForm({ ...catForm, subcategories: e.target.value })
                }
              />
            </div>
            <button
              style={styles.primaryBtn}
              onClick={addOrUpdateCategory}
            >
              {editingCatId ? "Update Category" : "Add Category"}
            </button>
            {editingCatId && (
              <button
                style={{ ...styles.primaryBtn, background: "#6b7280", marginLeft: 10 }}
                onClick={() => {
                  setEditingCatId(null);
                  setCatForm({ name: "", subcategories: "" });
                }}
              >
                Cancel
              </button>
            )}
            <h3>Categories</h3>
            {categories.map((cat) => (
              <div key={cat._id} style={styles.card}>
                <div>
                  <b>{cat.name}</b>: {cat.subcategories.join(", ")}
                </div>
                <button
                  style={styles.editBtn}
                  onClick={() => editCategory(cat)}
                >
                  Edit
                </button>
                <button
                  style={styles.deleteBtn}
                  onClick={() => deleteCategory(cat._id)}
                >
                  Delete
                </button>
              </div>
            ))}
          </section>
        )}
        {/* SLIDER */}
        {active === "slider" && (
          <section>
            <h3>{editingSlideId ? "Edit Slide" : "Add Slide"}</h3>
            <div style={styles.formGrid}>
              <input
                style={styles.input}
                placeholder="Title"
                value={slideForm.title}
                onChange={(e) =>
                  setSlideForm({ ...slideForm, title: e.target.value })
                }
              />
              <input
                style={styles.input}
                placeholder="Link"
                value={slideForm.link}
                onChange={(e) =>
                  setSlideForm({ ...slideForm, link: e.target.value })
                }
              />
              <input
                style={styles.fileInput}
                type="file"
                onChange={(e) =>
                  setSlideForm({ ...slideForm, image: e.target.files[0] })
                }
              />
            </div>
            <button style={styles.primaryBtn} onClick={addSlide}>
              {editingSlideId ? "Update Slide" : "Add Slide"}
            </button>
            {editingSlideId && (
              <button
                style={{ ...styles.primaryBtn, background: "#6b7280", marginLeft: 10 }}
                onClick={() => {
                  setEditingSlideId(null);
                  setSlideForm({ title: "", link: "", image: null });
                }}
              >
                Cancel
              </button>
            )}
            {slides.map((s) => (
              <div key={s._id} style={styles.card}>
                <img src={s.image} width="100" alt="Slide" />
                <div>{s.title} - {s.link}</div>
                <button style={styles.editBtn} onClick={() => editSlide(s)}>Edit</button>
                <button style={styles.deleteBtn} onClick={() => deleteSlide(s._id)}>Delete</button>
              </div>
            ))}
            {expandedOrder.products.map((p, i) => (
              <tr key={i}>
                <td>{p.title}</td>
                <td align="center">{p.quantity || 1}</td>
                <td align="center">₹{p.price}</td>
                <td align="center">
                  ₹{(p.quantity || 1) * p.price}
                </td>
              </tr>
            ))}
          </tbody>
                  </table>
    </div>
              </div >
            )
}
<div style={styles.pagination}>
  <button onClick={() => prevPage(orderPage, setOrderPage)}>Prev</button>
  <span>Page {orderPage}</span>
  <button onClick={() => nextPage(orderPage, setOrderPage, orders.length)}>Next</button>
</div>
          </section >
        )}
{/* USERS */ }
{
  active === "users" && (
    <section>
      <div style={styles.searchRow}>
        <input
          style={styles.searchInput}
          placeholder="Search users by name or email..."
          value={search.users}
          onChange={(e) => handleSearchChange('users', e.target.value)}
        />
      </div>
      <table style={styles.table}>
        <thead>
          <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Supercoins</th>
            <th>Status</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          {paginatedUsers.map((u) => (
            <tr key={u._id}>
              <td>{u.name}</td>
              <td>{u.email}</td>
              <td>{u.phone}</td>
              <td>{u.supercoins}</td>
              <td>
                {u.isBanned ? (
                  <span style={styles.banned}>BANNED</span>
                ) : (
                  <span style={styles.active}>ACTIVE</span>
                )}
              </td>
              <td>
                <button
                  style={{
                    ...styles.primaryBtn,
                    background: u.isBanned ? "#16a34a" : "#dc2626",
                  }}
                  onClick={async () => {
                    await API.patch(`/api/admin/users/${u._id}/ban`);
                    fetchAll();
                  }}
                >
                  {u.isBanned ? "Unban" : "Ban"}
                </button>
              </td>
            </tr>
          ))}
        </tbody>
      </table>
      <div style={styles.pagination}>
        <button onClick={() => prevPage(userPage, setUserPage)}>Prev</button>
        <span>Page {userPage}</span>
        <button onClick={() => nextPage(userPage, setUserPage, users.length)}>Next</button>
      </div>
    </section>
  )
}
{/* CATEGORIES */ }
{
  active === "categories" && (
    <section>
      <h3>{editingCatId ? "Update Category" : "Add Category"}</h3>
      <div style={styles.formGrid}>
        <input
          style={styles.input}
          placeholder="Category Name"
          value={catForm.name}
          onChange={(e) =>
            setCatForm({ ...catForm, name: e.target.value })
          }
        />
        <textarea
          style={{ ...styles.input, height: "80px" }}
          placeholder="Subcategories (comma separated)"
          value={catForm.subcategories}
          onChange={(e) =>
            setCatForm({ ...catForm, subcategories: e.target.value })
          }
        />
      </div>
      <button
        style={styles.primaryBtn}
        onClick={addOrUpdateCategory}
      >
        {editingCatId ? "Update Category" : "Add Category"}
      </button>
      {editingCatId && (
        <button
          style={{ ...styles.primaryBtn, background: "#6b7280", marginLeft: 10 }}
          onClick={() => {
            setEditingCatId(null);
            setCatForm({ name: "", subcategories: "" });
          }}
        >
          Cancel
        </button>
      )}
      <h3>Categories</h3>
      {categories.map((cat) => (
        <div key={cat._id} style={styles.card}>
          <div>
            <b>{cat.name}</b>: {cat.subcategories.join(", ")}
          </div>
          <button
            style={styles.editBtn}
            onClick={() => editCategory(cat)}
          >
            Edit
          </button>
          <button
            style={styles.deleteBtn}
            onClick={() => deleteCategory(cat._id)}
          >
            Delete
          </button>
        </div>
      ))}
    </section>
  )
}
{/* SLIDER */ }
{
  active === "slider" && (
    <section>
      <h3>{editingSlideId ? "Edit Slide" : "Add Slide"}</h3>
      <div style={styles.formGrid}>
        <input
          style={styles.input}
          placeholder="Title"
          value={slideForm.title}
          onChange={(e) =>
            setSlideForm({ ...slideForm, title: e.target.value })
          }
        />
        <input
          style={styles.input}
          placeholder="Link"
          value={slideForm.link}
          onChange={(e) =>
            setSlideForm({ ...slideForm, link: e.target.value })
          }
        />
        <input
          style={styles.fileInput}
          type="file"
          onChange={(e) =>
            setSlideForm({ ...slideForm, image: e.target.files[0] })
          }
        />
      </div>
      <button style={styles.primaryBtn} onClick={addSlide}>
        {editingSlideId ? "Update Slide" : "Add Slide"}
      </button>
      {editingSlideId && (
        <button
          style={{ ...styles.primaryBtn, background: "#6b7280", marginLeft: 10 }}
          onClick={() => {
            setEditingSlideId(null);
            setSlideForm({ title: "", link: "", image: null });
          }}
        >
          Cancel
        </button>
      )}
      {slides.map((s) => (
        <div key={s._id} style={styles.card}>
          <img src={s.image} width="100" alt="Slide" />
          <div>{s.title} - {s.link}</div>
          <button style={styles.editBtn} onClick={() => editSlide(s)}>Edit</button>
          <button style={styles.deleteBtn} onClick={() => deleteSlide(s._id)}>Delete</button>
        </div>
      ))}
    </section>
  )
}
      </main >
    </div >
  );
function OrderTimeline({ status, createdAt, updatedAt }) {
  const currentIndex = ORDER_FLOW.indexOf(status);
  return (
    <div style={timelineStyles.wrapper}>
      {ORDER_FLOW.map((step, index) => {
        const isCompleted = index < currentIndex;
        const isActive = index === currentIndex;
        return (
          <div key={step} style={timelineStyles.step}>
            {/* Line */}
            {index !== 0 && (
              <div
                style={{
                  ...timelineStyles.line,
                  background: isCompleted ? "linear-gradient(180deg, #667eea 0%, #764ba2 100%)" : "#e5e7eb",
                }}
              />
            )}
            {/* Dot */}
            <div
              style={{
                ...timelineStyles.dot,
                background: isCompleted
                  ? "linear-gradient(135deg, #667eea 0%, #764ba2 100%)"
                  : isActive
                    ? "linear-gradient(135deg, #10b981 0%, #059669 100%)"
                    : "#cbd5e1",
                boxShadow: isActive ? "0 0 0 4px rgba(16, 185, 129, 0.2)" : "none",
              }}
            />
            {/* Label */}
            <div style={timelineStyles.label}>
              <b style={{ color: isActive ? "#059669" : "#334155" }}>{step}</b>
              {index === 0 && (
                <div style={timelineStyles.date}>
                  {new Date(createdAt).toLocaleString()}
                </div>
              )}
              {isActive && updatedAt && (
                <div style={timelineStyles.date}>
                  Updated: {new Date(updatedAt).toLocaleString()}
                </div>
              )}
            </div>
          </div>
        );
      })}
    </div>
  );
}
}

/* ================= STYLES ================= */
const styles = {
  layout: {
    display: "flex",
    minHeight: "100vh",
    background: "linear-gradient(135deg, #667eea 0%, #764ba2 100%)",
    fontFamily: "'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif",
  },
  sidebar: {
    width: 260,
    background: "linear-gradient(180deg, #1e293b 0%, #0f172a 100%)",
    color: "#fff",
    padding: "28px 20px",
    boxShadow: "4px 0 24px rgba(0,0,0,0.12)",
    position: "relative",
  },
  logo: {
    fontSize: 26,
    fontWeight: 800,
    marginBottom: 40,
    background: "linear-gradient(135deg, #667eea 0%, #764ba2 100%)",
    WebkitBackgroundClip: "text",
    WebkitTextFillColor: "transparent",
    backgroundClip: "text",
    letterSpacing: "-0.5px",
  },
  menuBtn: {
    width: "100%",
    padding: "14px 18px",
    marginBottom: 8,
    border: "none",
    borderRadius: 12,
    color: "#cbd5e1",
    fontWeight: 600,
    cursor: "pointer",
    textAlign: "left",
    fontSize: "15px",
    transition: "all 0.3s cubic-bezier(0.4, 0, 0.2, 1)",
    position: "relative",
    overflow: "hidden",
  },
  main: {
    flex: 1,
    padding: 32,
    background: "#f8fafc",
    overflowY: "auto",
  },
  header: {
    display: "flex",
    justifyContent: "space-between",
    alignItems: "center",
    marginBottom: 32,
    padding: "24px 28px",
    background: "linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.7) 100%)",
    backdropFilter: "blur(10px)",
    borderRadius: 16,
    boxShadow: "0 8px 32px rgba(0,0,0,0.08)",
    border: "1px solid rgba(255,255,255,0.5)",
  },
  formGrid: {
    display: "grid",
    gridTemplateColumns: "repeat(2,1fr)",
    gap: 20,
    marginBottom: 24,
  },
  input: {
    padding: "14px 18px",
    borderRadius: 12,
    border: "2px solid #e2e8f0",
    fontSize: 15,
    background: "#ffffff",
    outline: "none",
    transition: "all 0.3s ease",
    fontFamily: "inherit",
  },
  fileInput: {
    padding: 14,
    borderRadius: 12,
    border: "2px dashed #cbd5e1",
    background: "linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%)",
    cursor: "pointer",
    transition: "all 0.3s ease",
    fontSize: 14,
    fontWeight: 500,
  },
  primaryBtn: {
    padding: "12px 24px",
    background: "linear-gradient(135deg, #667eea 0%, #764ba2 100%)",
    color: "#fff",
    border: "none",
    borderRadius: 12,
    fontWeight: 600,
    cursor: "pointer",
    marginBottom: 20,
    fontSize: 15,
    transition: "all 0.3s cubic-bezier(0.4, 0, 0.2, 1)",
    boxShadow: "0 4px 16px rgba(102, 126, 234, 0.4)",
  },
  logoutBtn: {
    padding: "10px 20px",
    background: "linear-gradient(135deg, #f43f5e 0%, #dc2626 100%)",
    color: "#fff",
    border: "none",
    borderRadius: 10,
    fontWeight: 600,
    cursor: "pointer",
    fontSize: 14,
    transition: "all 0.3s ease",
    boxShadow: "0 4px 12px rgba(239, 68, 68, 0.3)",
  },
  card: {
    background: "linear-gradient(135deg, #ffffff 0%, #f8fafc 100%)",
    padding: 20,
    borderRadius: 16,
    display: "flex",
    alignItems: "center",
    gap: 16,
    marginBottom: 16,
    boxShadow: "0 4px 20px rgba(0,0,0,0.06)",
    justifyContent: "space-between",
    border: "1px solid rgba(226, 232, 240, 0.8)",
    transition: "all 0.3s ease",
  },
  orderDetails: {
    background: "linear-gradient(135deg, #ffffff 0%, #f8fafc 100%)",
    padding: 28,
    borderRadius: 16,
    marginTop: 24,
    boxShadow: "0 8px 32px rgba(0,0,0,0.08)",
    border: "1px solid rgba(226, 232, 240, 0.8)",
  },
  orderSection: {
    marginBottom: 20,
    padding: "16px 20px",
    border: "2px solid #e2e8f0",
    borderRadius: 12,
    background: "#fafbfc",
    transition: "all 0.3s ease",
  },
  editBtn: {
    padding: "8px 16px",
    background: "linear-gradient(135deg, #10b981 0%, #059669 100%)",
    color: "#fff",
    border: "none",
    borderRadius: 8,
    fontSize: 13,
    fontWeight: 600,
    cursor: "pointer",
    marginRight: 6,
    transition: "all 0.3s ease",
    boxShadow: "0 2px 8px rgba(16, 185, 129, 0.3)",
  },
  deleteBtn: {
    padding: "8px 16px",
    background: "linear-gradient(135deg, #ef4444 0%, #dc2626 100%)",
    color: "#fff",
    border: "none",
    borderRadius: 8,
    fontSize: 13,
    fontWeight: 600,
    cursor: "pointer",
    transition: "all 0.3s ease",
    boxShadow: "0 2px 8px rgba(239, 68, 68, 0.3)",
  },
  viewBtn: {
    padding: "8px 16px",
    background: "linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)",
    color: "#fff",
    border: "none",
    borderRadius: 8,
    fontSize: 13,
    fontWeight: 600,
    cursor: "pointer",
    marginLeft: 6,
    marginRight: 6,
    transition: "all 0.3s ease",
    boxShadow: "0 2px 8px rgba(37, 99, 235, 0.3)",
  },
  table: {
    width: "100%",
    borderCollapse: "separate",
    borderSpacing: 0,
    background: "#ffffff",
    borderRadius: 16,
    overflow: "hidden",
    boxShadow: "0 8px 32px rgba(0,0,0,0.08)",
    border: "1px solid rgba(226, 232, 240, 0.8)",
  },
  th: {
    background: "linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%)",
    padding: "16px 18px",
    textAlign: "left",
    fontWeight: 700,
    fontSize: 14,
    color: "#475569",
    textTransform: "uppercase",
    letterSpacing: "0.5px",
  },
  td: {
    padding: "16px 18px",
    borderBottom: "1px solid #f1f5f9",
    fontSize: 14,
    color: "#334155",
  },
  statusBadge: {
    padding: "6px 12px",
    borderRadius: 20,
    fontSize: 12,
    fontWeight: 700,
    textTransform: "uppercase",
    letterSpacing: "0.5px",
    display: "inline-block",
  },
  statusBadgeColors: {
    pending: { color: "#ef4444", background: "#fee2e2" },
    processing: { color: "#f59e0b", background: "#fef3c7" },
    confirmed: { color: "#2563eb", background: "#dbeafe" },
    shipped: { color: "#9333ea", background: "#f3e8ff" },
    delivered: { color: "#16a34a", background: "#dcfce7" },
  },
  banned: {
    color: "#dc2626",
    fontWeight: 800,
    fontSize: 13,
    textTransform: "uppercase",
    letterSpacing: "0.5px",
  },
  active: {
    color: "#16a34a",
    fontWeight: 800,
    fontSize: 13,
    textTransform: "uppercase",
    letterSpacing: "0.5px",
  },
  searchRow: {
    marginBottom: 24,
  },
  searchInput: {
    padding: "14px 20px",
    borderRadius: 12,
    border: "2px solid #e2e8f0",
    width: "100%",
    maxWidth: "400px",
    fontSize: 15,
    outline: "none",
    transition: "all 0.3s ease",
    background: "#ffffff",
    fontFamily: "inherit",
  },
  pagination: {
    display: "flex",
    justifyContent: "center",
    alignItems: "center",
    gap: 16,
    marginTop: 28,
    padding: "20px",
    background: "linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.7) 100%)",
    backdropFilter: "blur(10px)",
    borderRadius: 12,
    border: "1px solid rgba(226, 232, 240, 0.8)",
  },
  statsGrid: {
    display: "grid",
    gridTemplateColumns: "repeat(auto-fit, minmax(240px, 1fr))",
    gap: 24,
    marginTop: 24,
  },
  statCard: {
    background: "linear-gradient(135deg, #ffffff 0%, #f8fafc 100%)",
    padding: 28,
    borderRadius: 16,
    textAlign: "center",
    boxShadow: "0 8px 32px rgba(0,0,0,0.08)",
    border: "1px solid rgba(226, 232, 240, 0.8)",
    transition: "all 0.3s cubic-bezier(0.4, 0, 0.2, 1)",
    position: "relative",
    overflow: "hidden",
  },
  statValue: {
    fontSize: 36,
    fontWeight: 800,
    background: "linear-gradient(135deg, #667eea 0%, #764ba2 100%)",
    WebkitBackgroundClip: "text",
    WebkitTextFillColor: "transparent",
    backgroundClip: "text",
    margin: "8px 0 0 0",
    letterSpacing: "-1px",
  },
  loading: {
    textAlign: "center",
    padding: 40,
    fontSize: 18,
    fontWeight: 600,
    color: "#64748b",
    background: "linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.7) 100%)",
    backdropFilter: "blur(10px)",
    borderRadius: 16,
    margin: "20px 0",
  },
};

const timelineStyles = {
  wrapper: {
    display: "flex",
    flexDirection: "column",
    gap: 24,
    marginBottom: 32,
    paddingLeft: 12,
  },
  step: {
    display: "flex",
    alignItems: "flex-start",
    gap: 16,
    position: "relative",
  },
  line: {
    position: "absolute",
    left: 7,
    top: -24,
    width: 3,
    height: 24,
    borderRadius: 2,
  },
  dot: {
    width: 18,
    height: 18,
    borderRadius: "50%",
    marginTop: 4,
    transition: "all 0.3s ease",
    border: "3px solid #ffffff",
  },
  label: {
    fontSize: 15,
    fontWeight: 600,
  },
  date: {
    fontSize: 13,
    color: "#64748b",
    marginTop: 4,
    fontWeight: 400,
  },
};